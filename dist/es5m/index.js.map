{"version":3,"file":"index.js","sources":["../../src/interpreters.ts","../../src/interpreter.ts","../../src/defaults.ts"],"sourcesContent":["import { CompoundCondition, FieldCondition, Comparable } from '@ucast/core';\nimport { DynamoOperator } from './interpreter';\n\nexport const eq: DynamoOperator<FieldCondition> = (condition, query) => {\n  return query.where(condition.field, '=', condition.value);\n};\n\nexport const ne: DynamoOperator<FieldCondition> = (condition, query) => {\n  return query.where(condition.field, '<>', condition.value);\n};\n\nexport const lt: DynamoOperator<FieldCondition<Comparable>> = (\n  condition,\n  query\n) => {\n  return query.where(condition.field, '<', condition.value);\n};\n\nexport const lte: DynamoOperator<FieldCondition<Comparable>> = (\n  condition,\n  query\n) => {\n  return query.where(condition.field, '<=', condition.value);\n};\n\nexport const gt: DynamoOperator<FieldCondition<Comparable>> = (\n  condition,\n  query\n) => {\n  return query.where(condition.field, '>', condition.value);\n};\n\nexport const gte: DynamoOperator<FieldCondition<Comparable>> = (\n  condition,\n  query\n) => {\n  return query.where(condition.field, '>=', condition.value);\n};\n\nexport const exists: DynamoOperator<FieldCondition<Comparable>> = (\n  condition,\n  query\n) => {\n  if (condition.value) {\n    return query.whereRaw(`attribute_exists(${query.field(condition.field)})`);\n  }\n  return query.whereRaw(\n    `attribute_not_exists(${query.field(condition.field)})`\n  );\n};\n\nfunction manyParamsOperator(\n  name: string\n): DynamoOperator<FieldCondition<unknown[]>> {\n  return (condition, query) => {\n    return query.whereRaw(\n      `${query.field(condition.field)} ${name}(${query\n        .manyParams(condition.value)\n        .join(', ')})`\n    );\n  };\n}\n\nexport const within = manyParamsOperator('IN');\nexport const nin = manyParamsOperator('NOT IN');\n\nfunction compoundOperator(\n  combinator: 'AND' | 'OR',\n  isInverted: boolean = false\n) {\n  return ((node, query, { interpret }) => {\n    const childQuery = query.child();\n    node.value.forEach(condition => interpret(condition, childQuery));\n    return query.merge(childQuery, combinator, isInverted);\n  }) as DynamoOperator<CompoundCondition>;\n}\n\nexport const not = compoundOperator('AND', true);\nexport const and = compoundOperator('AND');\nexport const or = compoundOperator('OR');\nexport const nor = compoundOperator('OR', true);\n","import {\n  createInterpreter,\n  Condition,\n  InterpretationContext,\n} from '@ucast/core';\n\nexport class Query {\n  private _expressions: string[] = [];\n  private _names: Record<string, string> = {};\n  private _values: Record<string, unknown> = {};\n  private _placeholderString = 'p';\n  private _lastPlaceholderIndex: number = 1;\n\n  field(rawName: string) {\n    // support fields with the dot in name (escaped like 'a\\\\.b')\n    // and use placeholders to avoid conflicts with reserved words\n    //\n    // javascript doesn't support lookbehind, so reverse the string and use lookahead\n    const names = rawName\n      .split('')\n      .reverse()\n      .join('')\n      .split(/\\.(?!\\\\)/)!\n      .reverse()\n      .map(v => v.split('').reverse().join(''));\n\n    const keys = names.map(part => `#${part}`.replace(/\\\\\\./g, '_'));\n    keys.forEach((key, i) => {\n      this._names[key.replace(/\\[\\d+\\]/g, '')] = names[i]\n        .replace(/\\\\\\./g, '.')\n        .replace(/\\[\\d+\\]/g, '');\n    });\n    return keys.join('.');\n  }\n\n  param(value: unknown) {\n    const idx = this._lastPlaceholderIndex + Object.keys(this._values).length;\n    const key = `:${this._placeholderString}${idx}`;\n    this._values[key] = value;\n    return key;\n  }\n\n  manyParams(items: unknown[]) {\n    return items.map(value => this.param(value));\n  }\n\n  child() {\n    const query = new Query();\n    query._lastPlaceholderIndex = this._lastPlaceholderIndex + Object.keys(this._values).length;\n    return query;\n  }\n\n  where(field: string, operator: string, value: unknown) {\n    const expression = `${this.field(field)} ${operator} ${this.param(value)}`;\n    return this.whereRaw(expression);\n  }\n\n  whereRaw(expression: string) {\n    this._expressions.push(expression);\n    return this;\n  }\n\n  merge(\n    query: Query,\n    operator: 'AND' | 'OR' = 'AND',\n    isInverted: boolean = false\n  ) {\n    let expression = query._expressions.join(` ${operator} `);\n    if (expression[0] !== '(') {\n      expression = `(${expression})`;\n    }\n\n    this._expressions.push(`${isInverted ? 'NOT ' : ''}${expression}`);\n    this._names = { ...this._names, ...query._names };\n    this._values = { ...this._values, ...query._values };\n    return this;\n  }\n\n  toJSON(): [string, Record<string, string>, Record<string, unknown>] {\n    return [this._expressions.join(' AND '), this._names, this._values];\n  }\n}\n\nexport type DynamoOperator<C extends Condition> = (\n  condition: C,\n  query: Query,\n  context: InterpretationContext<DynamoOperator<C>>\n) => Query;\n\nexport function createDynamoInterpreter(\n  operators: Record<string, DynamoOperator<any>>\n) {\n  const interpret = createInterpreter<DynamoOperator<any>>(operators);\n  return (condition: Condition) => {\n    return interpret(condition, new Query()).toJSON();\n  };\n}\n","import * as interpreters from './interpreters';\n\nexport const allInterpreters = {\n  ...interpreters,\n  in: interpreters.within,\n};\n"],"names":["eq","condition","query","where","field","value","ne","lt","lte","gt","gte","exists","whereRaw","manyParamsOperator","name","manyParams","join","within","nin","compoundOperator","combinator","isInverted","node","interpret","childQuery","child","forEach","merge","not","and","or","nor","Query","_expressions","_names","_values","_placeholderString","_lastPlaceholderIndex","rawName","names","split","reverse","map","v","keys","part","replace","key","i","param","idx","Object","length","items","operator","expression","push","toJSON","createDynamoInterpreter","operators","createInterpreter","allInterpreters","interpreters","in"],"mappings":"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"}