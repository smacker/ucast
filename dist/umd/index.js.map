{"version":3,"file":"index.js","sources":["../../src/interpreters.ts","../../src/interpreter.ts","../../src/defaults.ts"],"sourcesContent":["import { CompoundCondition, FieldCondition, Comparable } from '@ucast/core';\nimport { DynamoOperator } from './interpreter';\n\nexport const eq: DynamoOperator<FieldCondition> = (condition, query) => {\n  return query.where(condition.field, '=', condition.value);\n};\n\nexport const ne: DynamoOperator<FieldCondition> = (condition, query) => {\n  return query.where(condition.field, '<>', condition.value);\n};\n\nexport const lt: DynamoOperator<FieldCondition<Comparable>> = (\n  condition,\n  query\n) => {\n  return query.where(condition.field, '<', condition.value);\n};\n\nexport const lte: DynamoOperator<FieldCondition<Comparable>> = (\n  condition,\n  query\n) => {\n  return query.where(condition.field, '<=', condition.value);\n};\n\nexport const gt: DynamoOperator<FieldCondition<Comparable>> = (\n  condition,\n  query\n) => {\n  return query.where(condition.field, '>', condition.value);\n};\n\nexport const gte: DynamoOperator<FieldCondition<Comparable>> = (\n  condition,\n  query\n) => {\n  return query.where(condition.field, '>=', condition.value);\n};\n\nexport const exists: DynamoOperator<FieldCondition<Comparable>> = (\n  condition,\n  query\n) => {\n  if (condition.value) {\n    return query.whereRaw(`attribute_exists(${query.field(condition.field)})`);\n  }\n  return query.whereRaw(\n    `attribute_not_exists(${query.field(condition.field)})`\n  );\n};\n\nfunction manyParamsOperator(\n  name: string\n): DynamoOperator<FieldCondition<unknown[]>> {\n  return (condition, query) => {\n    return query.whereRaw(\n      `${query.field(condition.field)} ${name}(${query\n        .manyParams(condition.value)\n        .join(', ')})`\n    );\n  };\n}\n\nexport const within = manyParamsOperator('IN');\nexport const nin = manyParamsOperator('NOT IN');\n\nfunction compoundOperator(\n  combinator: 'AND' | 'OR',\n  isInverted: boolean = false\n) {\n  return ((node, query, { interpret }) => {\n    const childQuery = query.child();\n    node.value.forEach(condition => interpret(condition, childQuery));\n    return query.merge(childQuery, combinator, isInverted);\n  }) as DynamoOperator<CompoundCondition>;\n}\n\nexport const not = compoundOperator('AND', true);\nexport const and = compoundOperator('AND');\nexport const or = compoundOperator('OR');\nexport const nor = compoundOperator('OR', true);\n","import {\n  createInterpreter,\n  Condition,\n  InterpretationContext,\n} from '@ucast/core';\n\nexport class Query {\n  private _expressions: string[] = [];\n  private _names: Record<string, string> = {};\n  private _values: Record<string, unknown> = {};\n  private _placeholderString = 'p';\n  private _lastPlaceholderIndex: number = 1;\n\n  field(rawName: string) {\n    // support fields with the dot in name (escaped like 'a\\\\.b')\n    // and use placeholders to avoid conflicts with reserved words\n    //\n    // javascript doesn't support lookbehind, so reverse the string and use lookahead\n    const names = rawName\n      .split('')\n      .reverse()\n      .join('')\n      .split(/\\.(?!\\\\)/)!\n      .reverse()\n      .map(v => v.split('').reverse().join(''));\n\n    const keys = names.map(part => `#${part}`.replace(/\\\\\\./g, '_'));\n    keys.forEach((key, i) => {\n      this._names[key.replace(/\\[\\d+\\]/g, '')] = names[i]\n        .replace(/\\\\\\./g, '.')\n        .replace(/\\[\\d+\\]/g, '');\n    });\n    return keys.join('.');\n  }\n\n  param(value: unknown) {\n    const idx = this._lastPlaceholderIndex + Object.keys(this._values).length;\n    const key = `:${this._placeholderString}${idx}`;\n    this._values[key] = value;\n    return key;\n  }\n\n  manyParams(items: unknown[]) {\n    return items.map(value => this.param(value));\n  }\n\n  child() {\n    const query = new Query();\n    query._lastPlaceholderIndex = this._lastPlaceholderIndex + Object.keys(this._values).length;\n    return query;\n  }\n\n  where(field: string, operator: string, value: unknown) {\n    const expression = `${this.field(field)} ${operator} ${this.param(value)}`;\n    return this.whereRaw(expression);\n  }\n\n  whereRaw(expression: string) {\n    this._expressions.push(expression);\n    return this;\n  }\n\n  merge(\n    query: Query,\n    operator: 'AND' | 'OR' = 'AND',\n    isInverted: boolean = false\n  ) {\n    let expression = query._expressions.join(` ${operator} `);\n    if (expression[0] !== '(') {\n      expression = `(${expression})`;\n    }\n\n    this._expressions.push(`${isInverted ? 'NOT ' : ''}${expression}`);\n    this._names = { ...this._names, ...query._names };\n    this._values = { ...this._values, ...query._values };\n    return this;\n  }\n\n  toJSON(): [string, Record<string, string>, Record<string, unknown>] {\n    return [this._expressions.join(' AND '), this._names, this._values];\n  }\n}\n\nexport type DynamoOperator<C extends Condition> = (\n  condition: C,\n  query: Query,\n  context: InterpretationContext<DynamoOperator<C>>\n) => Query;\n\nexport function createDynamoInterpreter(\n  operators: Record<string, DynamoOperator<any>>\n) {\n  const interpret = createInterpreter<DynamoOperator<any>>(operators);\n  return (condition: Condition) => {\n    return interpret(condition, new Query()).toJSON();\n  };\n}\n","import * as interpreters from './interpreters';\n\nexport const allInterpreters = {\n  ...interpreters,\n  in: interpreters.within,\n};\n"],"names":["eq","condition","query","where","field","value","ne","lt","lte","gt","gte","exists","whereRaw","manyParamsOperator","name","manyParams","join","within","nin","compoundOperator","combinator","isInverted","node","interpret","childQuery","child","forEach","merge","not","and","or","nor","Query","_expressions","_names","_values","_placeholderString","_lastPlaceholderIndex","rawName","names","split","reverse","map","v","keys","part","replace","key","i","param","idx","Object","length","items","operator","expression","push","toJSON","createDynamoInterpreter","operators","createInterpreter","allInterpreters","interpreters","in"],"mappings":";;;;;;MAGaA,EAAkC,GAAG,SAArCA,EAAqC,CAACC,SAAD,EAAYC,KAAZ,EAAsB;EACtE,SAAOA,KAAK,CAACC,KAAN,CAAYF,SAAS,CAACG,KAAtB,EAA6B,GAA7B,EAAkCH,SAAS,CAACI,KAA5C,CAAP;EACD;MAEYC,EAAkC,GAAG,SAArCA,EAAqC,CAACL,SAAD,EAAYC,KAAZ,EAAsB;EACtE,SAAOA,KAAK,CAACC,KAAN,CAAYF,SAAS,CAACG,KAAtB,EAA6B,IAA7B,EAAmCH,SAAS,CAACI,KAA7C,CAAP;EACD;MAEYE,EAA8C,GAAG,SAAjDA,EAAiD,CAC5DN,SAD4D,EAE5DC,KAF4D,EAGzD;EACH,SAAOA,KAAK,CAACC,KAAN,CAAYF,SAAS,CAACG,KAAtB,EAA6B,GAA7B,EAAkCH,SAAS,CAACI,KAA5C,CAAP;EACD;MAEYG,GAA+C,GAAG,SAAlDA,GAAkD,CAC7DP,SAD6D,EAE7DC,KAF6D,EAG1D;EACH,SAAOA,KAAK,CAACC,KAAN,CAAYF,SAAS,CAACG,KAAtB,EAA6B,IAA7B,EAAmCH,SAAS,CAACI,KAA7C,CAAP;EACD;MAEYI,EAA8C,GAAG,SAAjDA,EAAiD,CAC5DR,SAD4D,EAE5DC,KAF4D,EAGzD;EACH,SAAOA,KAAK,CAACC,KAAN,CAAYF,SAAS,CAACG,KAAtB,EAA6B,GAA7B,EAAkCH,SAAS,CAACI,KAA5C,CAAP;EACD;MAEYK,GAA+C,GAAG,SAAlDA,GAAkD,CAC7DT,SAD6D,EAE7DC,KAF6D,EAG1D;EACH,SAAOA,KAAK,CAACC,KAAN,CAAYF,SAAS,CAACG,KAAtB,EAA6B,IAA7B,EAAmCH,SAAS,CAACI,KAA7C,CAAP;EACD;MAEYM,MAAkD,GAAG,SAArDA,MAAqD,CAChEV,SADgE,EAEhEC,KAFgE,EAG7D;EACH,MAAID,SAAS,CAACI,KAAd,EAAqB;EACnB,WAAOH,KAAK,CAACU,QAAN,uBAAmCV,KAAK,CAACE,KAAN,CAAYH,SAAS,CAACG,KAAtB,CAAnC,OAAP;EACD;;EACD,SAAOF,KAAK,CAACU,QAAN,2BACmBV,KAAK,CAACE,KAAN,CAAYH,SAAS,CAACG,KAAtB,CADnB,OAAP;EAGD;;EAED,SAASS,kBAAT,CACEC,IADF,EAE6C;EAC3C,SAAO,UAACb,SAAD,EAAYC,KAAZ,EAAsB;EAC3B,WAAOA,KAAK,CAACU,QAAN,CACFV,KAAK,CAACE,KAAN,CAAYH,SAAS,CAACG,KAAtB,CADE,SAC8BU,IAD9B,SACsCZ,KAAK,CAC7Ca,UADwC,CAC7Bd,SAAS,CAACI,KADmB,EAExCW,IAFwC,CAEnC,IAFmC,CADtC,OAAP;EAKD,GAND;EAOD;;MAEYC,MAAM,GAAGJ,kBAAkB,CAAC,IAAD;MAC3BK,GAAG,GAAGL,kBAAkB,CAAC,QAAD;;EAErC,SAASM,gBAAT,CACEC,UADF,EAEEC,UAFF,EAGE;EAAA,MADAA,UACA;EADAA,IAAAA,UACA,GADsB,KACtB;EAAA;;EACA,SAAQ,UAACC,IAAD,EAAOpB,KAAP,QAAgC;EAAA,QAAhBqB,SAAgB,QAAhBA,SAAgB;EACtC,QAAMC,UAAU,GAAGtB,KAAK,CAACuB,KAAN,EAAnB;EACAH,IAAAA,IAAI,CAACjB,KAAL,CAAWqB,OAAX,CAAmB,UAAAzB,SAAS;EAAA,aAAIsB,SAAS,CAACtB,SAAD,EAAYuB,UAAZ,CAAb;EAAA,KAA5B;EACA,WAAOtB,KAAK,CAACyB,KAAN,CAAYH,UAAZ,EAAwBJ,UAAxB,EAAoCC,UAApC,CAAP;EACD,GAJD;EAKD;;MAEYO,GAAG,GAAGT,gBAAgB,CAAC,KAAD,EAAQ,IAAR;MACtBU,GAAG,GAAGV,gBAAgB,CAAC,KAAD;MACtBW,EAAE,GAAGX,gBAAgB,CAAC,IAAD;MACrBY,GAAG,GAAGZ,gBAAgB,CAAC,IAAD,EAAO,IAAP;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MC1EtBa,KAAb;EAAA;EAAA,SACUC,YADV,GACmC,EADnC;EAAA,SAEUC,MAFV,GAE2C,EAF3C;EAAA,SAGUC,OAHV,GAG6C,EAH7C;EAAA,SAIUC,kBAJV,GAI+B,GAJ/B;EAAA,SAKUC,qBALV,GAK0C,CAL1C;EAAA;;EAAA;;EAAA,SAOEjC,KAPF,GAOE,eAAMkC,OAAN,EAAuB;EAAA;;EACrB;EACA;EACA;EACA;EACA,QAAMC,KAAK,GAAGD,OAAO,CAClBE,KADW,CACL,EADK,EAEXC,OAFW,GAGXzB,IAHW,CAGN,EAHM,EAIXwB,KAJW,CAIL,UAJK,EAKXC,OALW,GAMXC,GANW,CAMP,UAAAC,CAAC;EAAA,aAAIA,CAAC,CAACH,KAAF,CAAQ,EAAR,EAAYC,OAAZ,GAAsBzB,IAAtB,CAA2B,EAA3B,CAAJ;EAAA,KANM,CAAd;EAQA,QAAM4B,IAAI,GAAGL,KAAK,CAACG,GAAN,CAAU,UAAAG,IAAI;EAAA,aAAI,OAAIA,IAAJ,EAAWC,OAAX,CAAmB,OAAnB,EAA4B,GAA5B,CAAJ;EAAA,KAAd,CAAb;EACAF,IAAAA,IAAI,CAAClB,OAAL,CAAa,UAACqB,GAAD,EAAMC,CAAN,EAAY;EACvB,MAAA,KAAI,CAACd,MAAL,CAAYa,GAAG,CAACD,OAAJ,CAAY,UAAZ,EAAwB,EAAxB,CAAZ,IAA2CP,KAAK,CAACS,CAAD,CAAL,CACxCF,OADwC,CAChC,OADgC,EACvB,GADuB,EAExCA,OAFwC,CAEhC,UAFgC,EAEpB,EAFoB,CAA3C;EAGD,KAJD;EAKA,WAAOF,IAAI,CAAC5B,IAAL,CAAU,GAAV,CAAP;EACD,GA3BH;;EAAA,SA6BEiC,KA7BF,GA6BE,eAAM5C,KAAN,EAAsB;EACpB,QAAM6C,GAAG,GAAG,KAAKb,qBAAL,GAA6Bc,MAAM,CAACP,IAAP,CAAY,KAAKT,OAAjB,EAA0BiB,MAAnE;EACA,QAAML,GAAG,SAAO,KAAKX,kBAAZ,GAAiCc,GAA1C;EACA,SAAKf,OAAL,CAAaY,GAAb,IAAoB1C,KAApB;EACA,WAAO0C,GAAP;EACD,GAlCH;;EAAA,SAoCEhC,UApCF,GAoCE,oBAAWsC,KAAX,EAA6B;EAAA;;EAC3B,WAAOA,KAAK,CAACX,GAAN,CAAU,UAAArC,KAAK;EAAA,aAAI,MAAI,CAAC4C,KAAL,CAAW5C,KAAX,CAAJ;EAAA,KAAf,CAAP;EACD,GAtCH;;EAAA,SAwCEoB,KAxCF,GAwCE,iBAAQ;EACN,QAAMvB,KAAK,GAAG,IAAI8B,KAAJ,EAAd;EACA9B,IAAAA,KAAK,CAACmC,qBAAN,GAA8B,KAAKA,qBAAL,GAA6Bc,MAAM,CAACP,IAAP,CAAY,KAAKT,OAAjB,EAA0BiB,MAArF;EACA,WAAOlD,KAAP;EACD,GA5CH;;EAAA,SA8CEC,KA9CF,GA8CE,eAAMC,KAAN,EAAqBkD,QAArB,EAAuCjD,KAAvC,EAAuD;EACrD,QAAMkD,UAAU,GAAM,KAAKnD,KAAL,CAAWA,KAAX,CAAN,SAA2BkD,QAA3B,SAAuC,KAAKL,KAAL,CAAW5C,KAAX,CAAvD;EACA,WAAO,KAAKO,QAAL,CAAc2C,UAAd,CAAP;EACD,GAjDH;;EAAA,SAmDE3C,QAnDF,GAmDE,kBAAS2C,UAAT,EAA6B;EAC3B,SAAKtB,YAAL,CAAkBuB,IAAlB,CAAuBD,UAAvB;;EACA,WAAO,IAAP;EACD,GAtDH;;EAAA,SAwDE5B,KAxDF,GAwDE,eACEzB,KADF,EAEEoD,QAFF,EAGEjC,UAHF,EAIE;EAAA,QAFAiC,QAEA;EAFAA,MAAAA,QAEA,GAFyB,KAEzB;EAAA;;EAAA,QADAjC,UACA;EADAA,MAAAA,UACA,GADsB,KACtB;EAAA;;EACA,QAAIkC,UAAU,GAAGrD,KAAK,CAAC+B,YAAN,CAAmBjB,IAAnB,OAA4BsC,QAA5B,OAAjB;;EACA,QAAIC,UAAU,CAAC,CAAD,CAAV,KAAkB,GAAtB,EAA2B;EACzBA,MAAAA,UAAU,SAAOA,UAAP,MAAV;EACD;;EAED,SAAKtB,YAAL,CAAkBuB,IAAlB,OAA0BnC,UAAU,GAAG,MAAH,GAAY,EAAhD,IAAqDkC,UAArD;;EACA,SAAKrB,MAAL,gBAAmB,KAAKA,MAAxB,EAAmChC,KAAK,CAACgC,MAAzC;EACA,SAAKC,OAAL,gBAAoB,KAAKA,OAAzB,EAAqCjC,KAAK,CAACiC,OAA3C;EACA,WAAO,IAAP;EACD,GAtEH;;EAAA,SAwEEsB,MAxEF,GAwEE,kBAAoE;EAClE,WAAO,CAAC,KAAKxB,YAAL,CAAkBjB,IAAlB,CAAuB,OAAvB,CAAD,EAAkC,KAAKkB,MAAvC,EAA+C,KAAKC,OAApD,CAAP;EACD,GA1EH;;EAAA;EAAA;EAmFO,SAASuB,uBAAT,CACLC,SADK,EAEL;EACA,MAAMpC,SAAS,GAAGqC,sBAAiB,CAAsBD,SAAtB,CAAnC;EACA,SAAO,UAAC1D,SAAD,EAA0B;EAC/B,WAAOsB,SAAS,CAACtB,SAAD,EAAY,IAAI+B,KAAJ,EAAZ,CAAT,CAAkCyB,MAAlC,EAAP;EACD,GAFD;EAGD;;MC9FYI,eAAe,gBACvBC,YADuB;EAE1BC,EAAAA,EAAE,EAAED;EAFsB;;;;;;;;;;;;;;;;;;;;;;;;;"}